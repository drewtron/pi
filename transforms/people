#!/usr/bin/env gawk -f
@include "transforms/records";

#batch separators every N records, just a comment marker
#this is used as a split point piping along to parallel
NR%100==0 {
  print "//BATCH";
}

{
  escape();
  #fresh and clean, in specific to flush out the job time facets which
  #are long term stateful
  print "db.people.remove("
  printf "{ hashkey: 'person-%s'}", $1
  print ");\n"

  print "db.people.update("
  printf "{ hashkey: 'person-%s'}, ", $1
  printf "{ $set: {hashkey: 'person-%s', personid: %i, name: '%s', firstname: '%s', lastname: '%s', email: '%s'} },\n", $1, $1, $2, $3, $4, $5
  printf "{ upsert: true }\n"
  print ");\n"
}
